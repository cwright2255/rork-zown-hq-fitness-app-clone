<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Spotify Authentication</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: #0a0a0a;
      color: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      text-align: center;
      max-width: 400px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #333;
      border-top-color: #1DB954;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    h2 {
      margin: 0 0 10px;
      font-size: 18px;
      font-weight: 500;
    }
    p {
      margin: 0;
      color: #888;
      font-size: 14px;
    }
    .error {
      color: #ff6b6b;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner"></div>
    <h2 id="status">Processing Spotify authentication...</h2>
    <p id="substatus">Please wait...</p>
  </div>

  <script>
    (function() {
      const statusEl = document.getElementById('status');
      const substatusEl = document.getElementById('substatus');

      function showError(message) {
        statusEl.textContent = message;
        statusEl.classList.add('error');
        substatusEl.textContent = 'Redirecting back to app...';
      }

      function handleCallback() {
        try {
          const urlParams = new URLSearchParams(window.location.search);
          const hash = window.location.hash;
          
          const code = urlParams.get('code');
          const error = urlParams.get('error');
          const state = urlParams.get('state');
          
          console.log('Spotify callback HTML: code=' + !!code + ', error=' + error + ', state=' + state);

          if (error) {
            showError('Authentication error: ' + error);
            setTimeout(function() {
              window.location.href = '/profile/settings';
            }, 2000);
            return;
          }

          if (code) {
            statusEl.textContent = 'Authentication successful!';
            substatusEl.textContent = 'Completing connection...';
            
            // Store the code in localStorage for the app to pick up
            localStorage.setItem('spotify_auth_code', code);
            localStorage.setItem('spotify_auth_state', state || '');
            localStorage.setItem('spotify_auth_timestamp', Date.now().toString());
            
            // If opened as popup, communicate with opener
            if (window.opener && !window.opener.closed) {
              try {
                window.opener.postMessage({
                  type: 'SPOTIFY_AUTH_CODE',
                  code: code,
                  state: state,
                  url: window.location.href
                }, '*');
                
                setTimeout(function() {
                  window.close();
                }, 500);
                return;
              } catch (e) {
                console.log('Could not communicate with opener:', e);
              }
            }
            
            // Redirect to profile settings
            setTimeout(function() {
              window.location.href = '/profile/settings?spotify_connected=true';
            }, 1000);
            return;
          }

          // Check for implicit grant (hash fragment)
          if (hash && hash.includes('access_token')) {
            statusEl.textContent = 'Authentication successful!';
            substatusEl.textContent = 'Completing connection...';
            
            const hashParams = new URLSearchParams(hash.substring(1));
            const accessToken = hashParams.get('access_token');
            const tokenType = hashParams.get('token_type');
            const expiresIn = hashParams.get('expires_in');
            
            if (accessToken) {
              localStorage.setItem('spotify_access_token', accessToken);
              localStorage.setItem('spotify_token_type', tokenType || 'Bearer');
              localStorage.setItem('spotify_expires_in', expiresIn || '3600');
              localStorage.setItem('spotify_auth_timestamp', Date.now().toString());
            }
            
            if (window.opener && !window.opener.closed) {
              try {
                window.opener.postMessage({
                  type: 'SPOTIFY_AUTH_TOKEN',
                  accessToken: accessToken,
                  tokenType: tokenType,
                  expiresIn: expiresIn
                }, '*');
                
                setTimeout(function() {
                  window.close();
                }, 500);
                return;
              } catch (e) {
                console.log('Could not communicate with opener:', e);
              }
            }
            
            setTimeout(function() {
              window.location.href = '/profile/settings?spotify_connected=true';
            }, 1000);
            return;
          }

          // No auth data found
          showError('No authentication data found');
          setTimeout(function() {
            window.location.href = '/profile/settings';
          }, 2000);
          
        } catch (e) {
          console.error('Error handling callback:', e);
          showError('Error processing authentication');
          setTimeout(function() {
            window.location.href = '/profile/settings';
          }, 2000);
        }
      }

      // Run after a small delay to ensure page is ready
      setTimeout(handleCallback, 100);
    })();
  </script>
</body>
</html>
